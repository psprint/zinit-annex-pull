#!/usr/bin/env zsh
# -*- mode: sh; sh-indentation: 4; indent-tabs-mode: nil; sh-basic-offset: 4; -*-

# Copyright (c) 2022 Sebastian Gniazdowski

# Set the base and typically useful options
emulate -LR zsh
setopt extendedglob warncreateglobal typesetsilent noshortloops rcquotes ${${options[xtrace]:#off}:+xtrace}
typeset -gA Plugins

# Handle $0 according to the Zsh Plugin Standard:
# https://zdharma-continuum.github.io/Zsh-100-Commits-Club/Zsh-Plugin-Standard.html
0=${${ZERO:-${0:#$ZSH_ARGZERO}}:-${(%):-%N}}
0=${${(M)0##/*}:-$PWD/$0}

# Such global variable is expected to be typeset'd -g in the plugin.zsh
# file. Here it's restored in case of the function being run as a script.
Plugins[PULL_DIR]=${0:h}
Plugins[PULL_TMP]=$(mktemp)

local tmp=$Plugins[PULL_TMP] line
local -a lines
wget $2 -O $tmp &>/dev/null

# Strip tags, etc.
local file=$(<$tmp)
file=${file//<[^>]#>/}
file=${file//\&lt\;/<}
file=${file//\&gt\;/>}
print -r -- $file >! $tmp-

() { fc -p -a $tmp-; lines=( $history[@] ); }

integer next
local bit exts="${(j:|:)${(@)${(@Akons:|:)${ZINIT_EXTS[ice-mods]//\'\'/}}/(#s)<->-/}}"
local searched=$3

for line in $lines[@]; do
    set -- "${(Z+Cn+@)line}"
    if [[ $* = (#b)*(zi(#B)(|nit)[[:space:]]##((--|)(${~ZINIT[ice-list]}${~exts})([^[:space:]]#)[[:space:]]##)#)\
for(#B)([[:space:]]##((--|)(${~ZINIT[ice-list]}${~exts})([^[:space:]]#)[[:space:]]##)#\
([^[:space:]]##~(${~ZINIT[ice-list]}${~exts})))#(#b)((#B)[[:space:]]##((--|)(${~ZINIT[ice-list]}${~exts})([^[:space:]]#)[[:space:]]##)##\
$searched)(#B)([[:space:]]##((--|)(${~ZINIT[ice-list]}${~exts})([^[:space:]]#)[[:space:]]##)#\
[^[:space:]]##)# ]]; then
        print $match[1] \\n2:$match[2] \\n3:$match[3] \\n$match
    fi
done

# vim:ft=zsh:tw=80:sw=4:sts=4:et:foldmarker=[[[,]]]
